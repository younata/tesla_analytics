version: '2'
services:
  migrate:
    build: .
    command: python tasks.py db upgrade
    links:
      - database
    environment:
      DB_URL: postgres://${PG_USER}:${PG_PASS}@database/${PG_DB}

  frontend:
    build: .
    command: python tasks.py web
    links:
      - database
    depends_on:
      - "migrate"
    environment:
      DB_URL: postgres://${PG_USER}:${PG_PASS}@database/${PG_DB}

  worker:
    build: .
    command: python tasks.py monitor
    links:
      - database
    depends_on:
      - "migrate"
    environment:
      DB_URL: postgres://${PG_USER}:${PG_PASS}@database/${PG_DB}
      TESLA_EMAIL: ${TESLA_EMAIL}
      TESLA_PASS: ${TESLA_PASS}

  database:
    image: "postgres:latest"
    environment:
      POSTGRES_DB: ${PG_DB}
      POSTGRES_USER: ${PG_USER}
      POSTGRES_PASSWORD: ${PG_PASS}
      PGDATA: /data/db
    volumes:
      - ./data/db:/data/db
